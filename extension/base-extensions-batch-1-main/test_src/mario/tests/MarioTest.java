package mario.tests;

import static org.junit.Assert.assertEquals;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Arrays;
import java.util.Collection;
import java.util.List;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.junit.runners.Parameterized;

import mario.Mario;
import support.cse131.LenientTextUtils;
import support.cse131.LenientTextUtils.WhitespacePolicy;
import support.cse131.SystemOutputUtils;
import test.cse131.Messages;

/**
 * @author Dennis Cosgrove (http://www.cse.wustl.edu/~cosgroved/)
 */
@RunWith(Parameterized.class)
public class MarioTest {
	private final int size;
	private final int pattern;
	private final List<String> expectedLines;

	public MarioTest(int size, int pattern, List<String> expectedLines) {
		this.size = size;
		this.pattern = pattern;
		this.expectedLines = expectedLines;
	}

	@Test
	public void test() throws IOException {
		InputStream sysInBackup = System.in; // backup System.in to restore it later
		String input = Integer.toString(size) + "\n" + Integer.toString(pattern) + "\n";
		ByteArrayInputStream in = new ByteArrayInputStream(input.getBytes());
		System.setIn(in);
		String actualOutput = SystemOutputUtils.capture(() -> {
			Mario.main(new String[] { });
		});

		List<String> actualCleanedLines = toCleanedMountainLines(actualOutput);
		assertEquals(toSizeMessage(actualOutput, actualCleanedLines), expectedLines.size(), actualCleanedLines.size());
		assertEquals(toEqualsMessage(actualOutput, actualCleanedLines), expectedLines, actualCleanedLines);
		System.setIn(sysInBackup);
	}

	private String toSizeMessage(String actualOutput, List<String> actualCleanedLines) {
		return toMessage(
				"\nIncorrect number of lines printed.\n    expected line count: " + expectedLines.size()
						+ "\n    (cleaned) actual line count: " + actualCleanedLines.size() + "\n\n",
				actualOutput, actualCleanedLines);
	}

	private String toEqualsMessage(String actualOutput, List<String> actualCleanedLines) {
		return toMessage("\nCorrect number of lines printed.\nHowever, the contents of each line is NOT correct.\n\n",
				actualOutput, actualCleanedLines);
	}

	private String toMessage(String prefix, String actualOutput, List<String> actualCleanedLines) {
		StringBuilder sb = new StringBuilder();
		sb.append("\nsize: " + size);
		sb.append("\npattern: " + pattern);
		sb.append("\n");
		sb.append(prefix);
		sb.append(Messages.toCompleteFromListOfStrings(actualOutput, expectedLines, actualCleanedLines));
		return sb.toString();
	}

	private static List<String> toCleanedMountainLines(String output) {
		// preserve the beginning whitespace
		// remove the ending whitespace
		// remove the empty lines
		List<String> clean = LenientTextUtils.toCleanedLines(output, WhitespacePolicy.PRESERVE, WhitespacePolicy.CLEAN,
				WhitespacePolicy.CLEAN);
		
		//remove first two lines as they are prompts
		return clean.subList(2, clean.size());
	}

	@Parameterized.Parameters(name = "size: {0}; pattern: {1}; expected: {2}")
	public static Collection<Object[]> getConstructorArguments() {
		return Arrays.asList(
				new Object[] { 1, 1, Arrays.asList("#") },

				new Object[] { 2, 1, Arrays.asList(" #", "##") },

				new Object[] { 4, 1, Arrays.asList("   #", "  ##", " ###", "####") },

				new Object[] { 5, 1, Arrays.asList("    #", "   ##", "  ###", " ####", "#####") },

				new Object[] { 9, 1,
						Arrays.asList("        #", "       ##", "      ###", "     ####", "    #####", "   ######",
								"  #######", " ########", "#########") },

				new Object[] { 42, 1, Arrays.asList("                                         #",
						"                                        ##", "                                       ###",
						"                                      ####", "                                     #####",
						"                                    ######", "                                   #######",
						"                                  ########", "                                 #########",
						"                                ##########", "                               ###########",
						"                              ############", "                             #############",
						"                            ##############", "                           ###############",
						"                          ################", "                         #################",
						"                        ##################", "                       ###################",
						"                      ####################", "                     #####################",
						"                    ######################", "                   #######################",
						"                  ########################", "                 #########################",
						"                ##########################", "               ###########################",
						"              ############################", "             #############################",
						"            ##############################", "           ###############################",
						"          ################################", "         #################################",
						"        ##################################", "       ###################################",
						"      ####################################", "     #####################################",
						"    ######################################", "   #######################################",
						"  ########################################", " #########################################",
						"##########################################") },

				new Object[] { 131, 1, Arrays.asList(
						"                                                                                                                                  #",
						"                                                                                                                                 ##",
						"                                                                                                                                ###",
						"                                                                                                                               ####",
						"                                                                                                                              #####",
						"                                                                                                                             ######",
						"                                                                                                                            #######",
						"                                                                                                                           ########",
						"                                                                                                                          #########",
						"                                                                                                                         ##########",
						"                                                                                                                        ###########",
						"                                                                                                                       ############",
						"                                                                                                                      #############",
						"                                                                                                                     ##############",
						"                                                                                                                    ###############",
						"                                                                                                                   ################",
						"                                                                                                                  #################",
						"                                                                                                                 ##################",
						"                                                                                                                ###################",
						"                                                                                                               ####################",
						"                                                                                                              #####################",
						"                                                                                                             ######################",
						"                                                                                                            #######################",
						"                                                                                                           ########################",
						"                                                                                                          #########################",
						"                                                                                                         ##########################",
						"                                                                                                        ###########################",
						"                                                                                                       ############################",
						"                                                                                                      #############################",
						"                                                                                                     ##############################",
						"                                                                                                    ###############################",
						"                                                                                                   ################################",
						"                                                                                                  #################################",
						"                                                                                                 ##################################",
						"                                                                                                ###################################",
						"                                                                                               ####################################",
						"                                                                                              #####################################",
						"                                                                                             ######################################",
						"                                                                                            #######################################",
						"                                                                                           ########################################",
						"                                                                                          #########################################",
						"                                                                                         ##########################################",
						"                                                                                        ###########################################",
						"                                                                                       ############################################",
						"                                                                                      #############################################",
						"                                                                                     ##############################################",
						"                                                                                    ###############################################",
						"                                                                                   ################################################",
						"                                                                                  #################################################",
						"                                                                                 ##################################################",
						"                                                                                ###################################################",
						"                                                                               ####################################################",
						"                                                                              #####################################################",
						"                                                                             ######################################################",
						"                                                                            #######################################################",
						"                                                                           ########################################################",
						"                                                                          #########################################################",
						"                                                                         ##########################################################",
						"                                                                        ###########################################################",
						"                                                                       ############################################################",
						"                                                                      #############################################################",
						"                                                                     ##############################################################",
						"                                                                    ###############################################################",
						"                                                                   ################################################################",
						"                                                                  #################################################################",
						"                                                                 ##################################################################",
						"                                                                ###################################################################",
						"                                                               ####################################################################",
						"                                                              #####################################################################",
						"                                                             ######################################################################",
						"                                                            #######################################################################",
						"                                                           ########################################################################",
						"                                                          #########################################################################",
						"                                                         ##########################################################################",
						"                                                        ###########################################################################",
						"                                                       ############################################################################",
						"                                                      #############################################################################",
						"                                                     ##############################################################################",
						"                                                    ###############################################################################",
						"                                                   ################################################################################",
						"                                                  #################################################################################",
						"                                                 ##################################################################################",
						"                                                ###################################################################################",
						"                                               ####################################################################################",
						"                                              #####################################################################################",
						"                                             ######################################################################################",
						"                                            #######################################################################################",
						"                                           ########################################################################################",
						"                                          #########################################################################################",
						"                                         ##########################################################################################",
						"                                        ###########################################################################################",
						"                                       ############################################################################################",
						"                                      #############################################################################################",
						"                                     ##############################################################################################",
						"                                    ###############################################################################################",
						"                                   ################################################################################################",
						"                                  #################################################################################################",
						"                                 ##################################################################################################",
						"                                ###################################################################################################",
						"                               ####################################################################################################",
						"                              #####################################################################################################",
						"                             ######################################################################################################",
						"                            #######################################################################################################",
						"                           ########################################################################################################",
						"                          #########################################################################################################",
						"                         ##########################################################################################################",
						"                        ###########################################################################################################",
						"                       ############################################################################################################",
						"                      #############################################################################################################",
						"                     ##############################################################################################################",
						"                    ###############################################################################################################",
						"                   ################################################################################################################",
						"                  #################################################################################################################",
						"                 ##################################################################################################################",
						"                ###################################################################################################################",
						"               ####################################################################################################################",
						"              #####################################################################################################################",
						"             ######################################################################################################################",
						"            #######################################################################################################################",
						"           ########################################################################################################################",
						"          #########################################################################################################################",
						"         ##########################################################################################################################",
						"        ###########################################################################################################################",
						"       ############################################################################################################################",
						"      #############################################################################################################################",
						"     ##############################################################################################################################",
						"    ###############################################################################################################################",
						"   ################################################################################################################################",
						"  #################################################################################################################################",
						" ##################################################################################################################################",
						"###################################################################################################################################") },

				new Object[] { 1, 2, Arrays.asList("#") },

				new Object[] { 2, 2, Arrays.asList("#", "##") },

				new Object[] { 4, 2, Arrays.asList("#", "##", "###", "####") },

				new Object[] { 5, 2, Arrays.asList("#", "##", "###", "####", "#####") },

				new Object[] { 9, 2,
						Arrays.asList("#", "##", "###", "####", "#####", "######", "#######", "########",
								"#########") },

				new Object[] { 42, 2, Arrays.asList("#", "##", "###", "####", "#####", "######", "#######", "########",
						"#########", "##########", "###########", "############", "#############", "##############",
						"###############", "################", "#################", "##################",
						"###################", "####################", "#####################",
						"######################", "#######################", "########################",
						"#########################", "##########################", "###########################",
						"############################", "#############################",
						"##############################", "###############################",
						"################################", "#################################",
						"##################################", "###################################",
						"####################################", "#####################################",
						"######################################", "#######################################",
						"########################################", "#########################################",
						"##########################################") },

				new Object[] { 131, 2, Arrays.asList("#", "##", "###", "####", "#####", "######", "#######", "########",
						"#########", "##########", "###########", "############", "#############", "##############",
						"###############", "################", "#################", "##################",
						"###################", "####################", "#####################",
						"######################", "#######################", "########################",
						"#########################", "##########################", "###########################",
						"############################", "#############################",
						"##############################", "###############################",
						"################################", "#################################",
						"##################################", "###################################",
						"####################################", "#####################################",
						"######################################", "#######################################",
						"########################################", "#########################################",
						"##########################################", "###########################################",
						"############################################", "#############################################",
						"##############################################",
						"###############################################",
						"################################################",
						"#################################################",
						"##################################################",
						"###################################################",
						"####################################################",
						"#####################################################",
						"######################################################",
						"#######################################################",
						"########################################################",
						"#########################################################",
						"##########################################################",
						"###########################################################",
						"############################################################",
						"#############################################################",
						"##############################################################",
						"###############################################################",
						"################################################################",
						"#################################################################",
						"##################################################################",
						"###################################################################",
						"####################################################################",
						"#####################################################################",
						"######################################################################",
						"#######################################################################",
						"########################################################################",
						"#########################################################################",
						"##########################################################################",
						"###########################################################################",
						"############################################################################",
						"#############################################################################",
						"##############################################################################",
						"###############################################################################",
						"################################################################################",
						"#################################################################################",
						"##################################################################################",
						"###################################################################################",
						"####################################################################################",
						"#####################################################################################",
						"######################################################################################",
						"#######################################################################################",
						"########################################################################################",
						"#########################################################################################",
						"##########################################################################################",
						"###########################################################################################",
						"############################################################################################",
						"#############################################################################################",
						"##############################################################################################",
						"###############################################################################################",
						"################################################################################################",
						"#################################################################################################",
						"##################################################################################################",
						"###################################################################################################",
						"####################################################################################################",
						"#####################################################################################################",
						"######################################################################################################",
						"#######################################################################################################",
						"########################################################################################################",
						"#########################################################################################################",
						"##########################################################################################################",
						"###########################################################################################################",
						"############################################################################################################",
						"#############################################################################################################",
						"##############################################################################################################",
						"###############################################################################################################",
						"################################################################################################################",
						"#################################################################################################################",
						"##################################################################################################################",
						"###################################################################################################################",
						"####################################################################################################################",
						"#####################################################################################################################",
						"######################################################################################################################",
						"#######################################################################################################################",
						"########################################################################################################################",
						"#########################################################################################################################",
						"##########################################################################################################################",
						"###########################################################################################################################",
						"############################################################################################################################",
						"#############################################################################################################################",
						"##############################################################################################################################",
						"###############################################################################################################################",
						"################################################################################################################################",
						"#################################################################################################################################",
						"##################################################################################################################################",
						"###################################################################################################################################") },

				new Object[] { 1, 3, Arrays.asList("#") },

				new Object[] { 2, 3, Arrays.asList("##", " #") },

				new Object[] { 4, 3, Arrays.asList("####", " ###", "  ##", "   #") },

				new Object[] { 5, 3, Arrays.asList("#####", " ####", "  ###", "   ##", "    #") },

				new Object[] { 9, 3,
						Arrays.asList("#########", " ########", "  #######", "   ######", "    #####", "     ####",
								"      ###", "       ##", "        #") },

				new Object[] { 42, 3, Arrays.asList("##########################################",
						" #########################################", "  ########################################",
						"   #######################################", "    ######################################",
						"     #####################################", "      ####################################",
						"       ###################################", "        ##################################",
						"         #################################", "          ################################",
						"           ###############################", "            ##############################",
						"             #############################", "              ############################",
						"               ###########################", "                ##########################",
						"                 #########################", "                  ########################",
						"                   #######################", "                    ######################",
						"                     #####################", "                      ####################",
						"                       ###################", "                        ##################",
						"                         #################", "                          ################",
						"                           ###############", "                            ##############",
						"                             #############", "                              ############",
						"                               ###########", "                                ##########",
						"                                 #########", "                                  ########",
						"                                   #######", "                                    ######",
						"                                     #####", "                                      ####",
						"                                       ###", "                                        ##",
						"                                         #") },

				new Object[] { 131, 3, Arrays.asList(
						"###################################################################################################################################",
						" ##################################################################################################################################",
						"  #################################################################################################################################",
						"   ################################################################################################################################",
						"    ###############################################################################################################################",
						"     ##############################################################################################################################",
						"      #############################################################################################################################",
						"       ############################################################################################################################",
						"        ###########################################################################################################################",
						"         ##########################################################################################################################",
						"          #########################################################################################################################",
						"           ########################################################################################################################",
						"            #######################################################################################################################",
						"             ######################################################################################################################",
						"              #####################################################################################################################",
						"               ####################################################################################################################",
						"                ###################################################################################################################",
						"                 ##################################################################################################################",
						"                  #################################################################################################################",
						"                   ################################################################################################################",
						"                    ###############################################################################################################",
						"                     ##############################################################################################################",
						"                      #############################################################################################################",
						"                       ############################################################################################################",
						"                        ###########################################################################################################",
						"                         ##########################################################################################################",
						"                          #########################################################################################################",
						"                           ########################################################################################################",
						"                            #######################################################################################################",
						"                             ######################################################################################################",
						"                              #####################################################################################################",
						"                               ####################################################################################################",
						"                                ###################################################################################################",
						"                                 ##################################################################################################",
						"                                  #################################################################################################",
						"                                   ################################################################################################",
						"                                    ###############################################################################################",
						"                                     ##############################################################################################",
						"                                      #############################################################################################",
						"                                       ############################################################################################",
						"                                        ###########################################################################################",
						"                                         ##########################################################################################",
						"                                          #########################################################################################",
						"                                           ########################################################################################",
						"                                            #######################################################################################",
						"                                             ######################################################################################",
						"                                              #####################################################################################",
						"                                               ####################################################################################",
						"                                                ###################################################################################",
						"                                                 ##################################################################################",
						"                                                  #################################################################################",
						"                                                   ################################################################################",
						"                                                    ###############################################################################",
						"                                                     ##############################################################################",
						"                                                      #############################################################################",
						"                                                       ############################################################################",
						"                                                        ###########################################################################",
						"                                                         ##########################################################################",
						"                                                          #########################################################################",
						"                                                           ########################################################################",
						"                                                            #######################################################################",
						"                                                             ######################################################################",
						"                                                              #####################################################################",
						"                                                               ####################################################################",
						"                                                                ###################################################################",
						"                                                                 ##################################################################",
						"                                                                  #################################################################",
						"                                                                   ################################################################",
						"                                                                    ###############################################################",
						"                                                                     ##############################################################",
						"                                                                      #############################################################",
						"                                                                       ############################################################",
						"                                                                        ###########################################################",
						"                                                                         ##########################################################",
						"                                                                          #########################################################",
						"                                                                           ########################################################",
						"                                                                            #######################################################",
						"                                                                             ######################################################",
						"                                                                              #####################################################",
						"                                                                               ####################################################",
						"                                                                                ###################################################",
						"                                                                                 ##################################################",
						"                                                                                  #################################################",
						"                                                                                   ################################################",
						"                                                                                    ###############################################",
						"                                                                                     ##############################################",
						"                                                                                      #############################################",
						"                                                                                       ############################################",
						"                                                                                        ###########################################",
						"                                                                                         ##########################################",
						"                                                                                          #########################################",
						"                                                                                           ########################################",
						"                                                                                            #######################################",
						"                                                                                             ######################################",
						"                                                                                              #####################################",
						"                                                                                               ####################################",
						"                                                                                                ###################################",
						"                                                                                                 ##################################",
						"                                                                                                  #################################",
						"                                                                                                   ################################",
						"                                                                                                    ###############################",
						"                                                                                                     ##############################",
						"                                                                                                      #############################",
						"                                                                                                       ############################",
						"                                                                                                        ###########################",
						"                                                                                                         ##########################",
						"                                                                                                          #########################",
						"                                                                                                           ########################",
						"                                                                                                            #######################",
						"                                                                                                             ######################",
						"                                                                                                              #####################",
						"                                                                                                               ####################",
						"                                                                                                                ###################",
						"                                                                                                                 ##################",
						"                                                                                                                  #################",
						"                                                                                                                   ################",
						"                                                                                                                    ###############",
						"                                                                                                                     ##############",
						"                                                                                                                      #############",
						"                                                                                                                       ############",
						"                                                                                                                        ###########",
						"                                                                                                                         ##########",
						"                                                                                                                          #########",
						"                                                                                                                           ########",
						"                                                                                                                            #######",
						"                                                                                                                             ######",
						"                                                                                                                              #####",
						"                                                                                                                               ####",
						"                                                                                                                                ###",
						"                                                                                                                                 ##",
						"                                                                                                                                  #") },

				new Object[] { 1, 4, Arrays.asList("#") },

				new Object[] { 2, 4, Arrays.asList("##", "#") },

				new Object[] { 4, 4, Arrays.asList("####", "###", "##", "#") },

				new Object[] { 5, 4, Arrays.asList("#####", "####", "###", "##", "#") },

				new Object[] { 9, 4,
						Arrays.asList("#########", "########", "#######", "######", "#####", "####", "###", "##",
								"#") },

				new Object[] { 42, 4, Arrays.asList("##########################################",
						"#########################################", "########################################",
						"#######################################", "######################################",
						"#####################################", "####################################",
						"###################################", "##################################",
						"#################################", "################################",
						"###############################", "##############################",
						"#############################", "############################", "###########################",
						"##########################", "#########################", "########################",
						"#######################", "######################", "#####################",
						"####################", "###################", "##################", "#################",
						"################", "###############", "##############", "#############", "############",
						"###########", "##########", "#########", "########", "#######", "######", "#####", "####",
						"###", "##", "#") },

				new Object[] { 131, 4, Arrays.asList(
						"###################################################################################################################################",
						"##################################################################################################################################",
						"#################################################################################################################################",
						"################################################################################################################################",
						"###############################################################################################################################",
						"##############################################################################################################################",
						"#############################################################################################################################",
						"############################################################################################################################",
						"###########################################################################################################################",
						"##########################################################################################################################",
						"#########################################################################################################################",
						"########################################################################################################################",
						"#######################################################################################################################",
						"######################################################################################################################",
						"#####################################################################################################################",
						"####################################################################################################################",
						"###################################################################################################################",
						"##################################################################################################################",
						"#################################################################################################################",
						"################################################################################################################",
						"###############################################################################################################",
						"##############################################################################################################",
						"#############################################################################################################",
						"############################################################################################################",
						"###########################################################################################################",
						"##########################################################################################################",
						"#########################################################################################################",
						"########################################################################################################",
						"#######################################################################################################",
						"######################################################################################################",
						"#####################################################################################################",
						"####################################################################################################",
						"###################################################################################################",
						"##################################################################################################",
						"#################################################################################################",
						"################################################################################################",
						"###############################################################################################",
						"##############################################################################################",
						"#############################################################################################",
						"############################################################################################",
						"###########################################################################################",
						"##########################################################################################",
						"#########################################################################################",
						"########################################################################################",
						"#######################################################################################",
						"######################################################################################",
						"#####################################################################################",
						"####################################################################################",
						"###################################################################################",
						"##################################################################################",
						"#################################################################################",
						"################################################################################",
						"###############################################################################",
						"##############################################################################",
						"#############################################################################",
						"############################################################################",
						"###########################################################################",
						"##########################################################################",
						"#########################################################################",
						"########################################################################",
						"#######################################################################",
						"######################################################################",
						"#####################################################################",
						"####################################################################",
						"###################################################################",
						"##################################################################",
						"#################################################################",
						"################################################################",
						"###############################################################",
						"##############################################################",
						"#############################################################",
						"############################################################",
						"###########################################################",
						"##########################################################",
						"#########################################################",
						"########################################################",
						"#######################################################",
						"######################################################",
						"#####################################################",
						"####################################################",
						"###################################################",
						"##################################################",
						"#################################################",
						"################################################",
						"###############################################",
						"##############################################",
						"#############################################", "############################################",
						"###########################################", "##########################################",
						"#########################################", "########################################",
						"#######################################", "######################################",
						"#####################################", "####################################",
						"###################################", "##################################",
						"#################################", "################################",
						"###############################", "##############################",
						"#############################", "############################", "###########################",
						"##########################", "#########################", "########################",
						"#######################", "######################", "#####################",
						"####################", "###################", "##################", "#################",
						"################", "###############", "##############", "#############", "############",
						"###########", "##########", "#########", "########", "#######", "######", "#####", "####",
						"###", "##", "#") }

		);
	}
}
